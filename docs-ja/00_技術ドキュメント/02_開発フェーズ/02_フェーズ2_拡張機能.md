# フェーズ2：拡張機能

このドキュメントでは、edvプロジェクトの2番目の開発フェーズについて詳細な内訳を提供します。このフェーズは、オーディオ処理、字幕サポート、基本的なタイムライン編集を含むコア機能の拡張に焦点を当てています。

## 概要

フェーズ2は、オーディオ処理、字幕のサポート、およびタイムライン編集コンセプトの導入によって、フェーズ1で確立された基盤の上に構築されます。このフェーズでは、基本的なビデオ操作を超えてツールの機能を大幅に拡張します。

**期間**: 4〜6週間

## 詳細なタスク

### オーディオ処理 (1〜2週目)

#### 1週目、1〜3日目
- ボリューム調整を実装
  - dBとパーセンテージベースの調整を開発
    - パラメータ解析を作成
    - FFmpegボリュームフィルターマッピングを実装
    - 範囲制限の検証を追加
  - 時間的なボリューム変更（フェードイン/アウト）を実装
    - フェードカーブ生成を作成
    - タイムスタンプパラメータ処理を追加
    - 複雑なフィルターの作成を実装

#### 1週目、3〜5日目
- オーディオ抽出を開発
  - フォーマット選択を実装
    - コーデックオプション処理を追加
    - フォーマット検証を作成
    - 複数の出力フォーマットをサポート
  - 品質管理を追加
    - ビットレート設定を実装
    - 品質パラメータマッピングを追加
    - プリセット設定を作成
  - メタデータ保存を実装
    - ソースメタデータを抽出
    - 関連フィールドを出力にマッピング
    - メタデータ変換を処理

#### 2週目、1〜3日目
- オーディオ置換を実装
  - 同期処理を開発
    - オフセットパラメータを実装
    - 自動同期検出を作成
    - ドリフト修正オプションを追加
  - マルチトラックサポートを追加
    - トラック選択を実装
    - トラックミキシング機能を作成
    - トラック分離をサポート
  - 必要に応じてフォーマット変換を実装
    - 互換性のないフォーマットを検出
    - 変換パイプラインを作成
    - 変換中の品質を保持

### 字幕サポート (2〜3週目)

#### 2週目、3〜5日目
- 字幕ローディングを実装
  - SRTフォーマットサポートを追加
    - SRTフォーマットのパーサーを作成
    - タイミング変換を実装
    - 文字エンコーディング検出を追加
  - VTTフォーマットサポートを実装
    - VTTフォーマットのパーサーを作成
    - スタイル情報をサポート
    - キュー設定を処理
  - 文字エンコーディング処理を追加
    - エンコーディング検出を実装
    - 変換ユーティリティを追加
    - フォールバックメカニズムを作成

#### 3週目、1〜3日目
- 字幕編集を開発
  - タイミング調整を実装
    - オフセット適用を作成
    - 速度変更のためのスケーリングを追加
    - フレームレート変換をサポート
  - テキスト修正を追加
    - テキスト置換を実装
    - 正規表現置換をサポート
    - 大文字小文字修正オプションを追加
  - スタイルカスタマイズを作成
    - フォントスタイルを実装
    - 色設定を追加
    - 位置調整をサポート

#### 3週目、3〜5日目
- 字幕焼き込みを実装
  - フォント選択とスタイリングを追加
    - フォントローディングを実装
    - スタイル設定を作成
    - カスタムフォントパスをサポート
  - 位置カスタマイズを開発
    - 位置パラメータを実装
    - 配置オプションを追加
    - マージンとパディングをサポート
  - FFmpegのフィルター生成を作成
    - 字幕フィルター文字列を構築
    - ビデオ処理と統合
    - プレビュー生成を実装

### タイムライン編集の基盤 (3〜5週目)

#### 3週目、3〜5日目から4週目、2日目
- タイムラインデータモデルを設計
  - トラックモデルを作成
    - トラック構造を定義
    - トラックタイプを実装
    - トラックプロパティをサポート
  - クリップ表現を実装
    - クリップ構造を定義
    - クリッププロパティを作成
    - 時間マッピングを実装
  - タイムラインのシリアル化を開発
    - ファイル形式を作成
    - 保存/読み込みを実装
    - バージョニングサポートを追加

#### 4週目、2〜5日目
- プロジェクト状態管理を実装
  - プロジェクトデータ構造を作成
    - プロジェクトパラメータを定義
    - プロジェクトメタデータを実装
    - プロジェクト設定を追加
  - 状態の永続化を開発
    - 保存/読み込み機能を実装
    - 自動保存機能を追加
    - プロジェクトバックアップメカニズムを作成
  - 変更追跡を実装
    - ダーティ状態検出を作成
    - 変更時間追跡を追加
    - 変更ログ記録を実装

#### 5週目、1〜3日目
- クリップ管理を開発
  - クリップの追加/削除を実装
    - クリップ挿入ロジックを作成
    - クリップ削除を実装
    - クリップ置換を追加
  - クリップ順序付けを作成
    - シーケンス管理を実装
    - 優先順位処理を追加
    - クリップ並べ替えをサポート
  - クリッププロパティを開発
    - プロパティシステムを作成
    - プロパティ検証を実装
    - プロパティ変更イベントを追加

#### 5週目、3〜5日目
- 基本的なタイムライン操作を実装
  - クリップの配置を開発
    - 時間配置を実装
    - スナップ機能を追加
    - オーバーラップ処理を作成
  - 期間調整を作成
    - トリム操作を実装
    - 期間制約を追加
    - 伸縮をサポート
  - トランジション管理を追加
    - トランジションタイプを実装
    - トランジションパラメータを作成
    - 期間調整をサポート

### 強化されたエラー処理とロギング (5〜6週目)

#### 5週目、3〜5日目
- 構造化ロギングシステムを実装
  - ロギングレベルを作成
    - レベル階層を定義
    - レベルフィルタリングを実装
    - コンテキストベースのレベルを追加
  - ログ出力先を開発
    - ファイルロギングを実装
    - コンソール出力を追加
    - リモートロギングをサポート
  - 構造化ロギング形式を追加
    - JSONフォーマッターを作成
    - フィールド抽出を実装
    - タイムスタンプとコンテキストを追加

#### 6週目、1〜3日目
- 詳細なエラータイプを開発
  - エラー階層を作成
    - 基本エラータイプを定義
    - 専門的なエラーを実装
    - エラーカテゴリ化を追加
  - エラーコンテキストを実装
    - コンテキスト情報を追加
    - エラーチェーンを作成
    - 原因追跡をサポート
  - 国際化サポートを追加
    - メッセージテンプレートを実装
    - 翻訳インフラを追加
    - ローカライズされたメッセージをサポート

#### 6週目、3〜5日目
- ユーザーフレンドリーなエラーメッセージを作成
  - エラーフォーマットを実装
    - 人間が読める形式を作成
    - 重大度によるカラーコーディングを追加
    - 詳細/概要モードをサポート
  - 解決策の提案を追加
    - 一般的な修正を実装
    - トラブルシューティングガイドを作成
    - ドキュメントリンクを追加
  - エラーコードを開発
    - 一意のエラー識別子を作成
    - ドキュメント検索を実装
    - オンラインリファレンスサポートを追加

- クラッシュリカバリーを実装
  - セッション状態の永続化を作成
    - 定期的な状態保存を実装
    - 緊急状態ダンプを追加
    - リカバリーファイル形式を作成
  - リカバリーメカニズムを開発
    - 起動時のリカバリー検出を実装
    - ユーザー通知を追加
    - 部分的な状態リカバリーをサポート

- 監査/元に戻すサポートのための操作ログを追加
  - 操作記録を実装
    - 操作ログを作成
    - パラメータキャプチャを追加
    - 結果ログをサポート
  - 元に戻すインフラストラクチャを開発
    - 操作の元に戻しを実装
    - 状態ロールバック機能を作成
    - トランザクショングループ化を追加

- デバッグ情報収集を構築
  - システム情報収集を作成
    - 環境検出を実装
    - 依存関係レポートを追加
    - 設定ダンプをサポート
  - クラッシュレポートを開発
    - クラッシュダンプメカニズムを作成
    - プライバシーのための墨消しを実装
    - 提出機能を追加

## 成果物

フェーズ2の終了までに、以下の成果物が完成している必要があります：

1. 完全なオーディオ処理機能
   - ボリューム調整
   - オーディオ抽出
   - オーディオ置換
2. 包括的な字幕サポート
   - SRTとVTTフォーマットの処理
   - 字幕編集機能
   - 字幕のビデオへの焼き込み
3. タイムライン編集の基盤
   - タイムライン編集のためのデータモデル
   - 基本的なクリップ管理
   - プロジェクト状態の永続化
4. 強化されたエラー処理とロギング
   - 構造化ロギングシステム
   - ユーザーフレンドリーなエラーメッセージ
   - クラッシュリカバリーメカニズム
5. 更新されたドキュメント
   - 新機能のユーザーガイド
   - 新モジュールのAPIドキュメント
   - 例示ワークフロー

## 成功基準

フェーズ2は以下の条件が満たされた場合に成功と見なされます：

- すべてのオーディオ処理操作が様々なフォーマットで確実に動作する
- 字幕サポートが一般的なフォーマットを処理し、基本的な編集を可能にする
- タイムラインモデルが基本的な編集操作と永続化をサポートする
- エラー処理がユーザーに明確なガイダンスを提供する
- テストが新機能の80%以上のコードカバレッジを提供する
- ドキュメントが例を含むすべての新機能をカバーしている

## 次のフェーズの準備

フェーズ2の最終週には、フェーズ3の準備を開始する必要があります：

- フェーズ2の実装をレビューする
- 新機能に関するフィードバックを収集する
- パフォーマンスのボトルネックを特定する
- 得られた教訓に基づいてフェーズ3の計画を改良する
- プロジェクトのロードマップを更新する

次の開発フェーズの詳細については、[フェーズ3：高度な機能](03_フェーズ3_高度な機能.md)を参照してください。

## 実装状況の更新（2024年）

### フェーズ2の完了状況：部分的に完了（80%）🔄

フェーズ2は現在進行中であり、オーディオ処理、字幕サポート、タイムライン機能に関して大きな成果を上げています。以下が現在の実装状況です：

#### 完了した成果物

1. **オーディオ処理機能**
   - ✅ ボリューム調整が実装済み（`src/audio/volume.rs`）
   - ✅ カスタマイズ可能なカーブを持つオーディオフェード（`src/audio/fade.rs`）
   - ✅ ビデオソースからのオーディオ抽出（`src/audio/extractor.rs`）
   - ✅ 同期機能を備えたオーディオ置換（`src/audio/replacer.rs`）
   - ✅ 一般的なオーディオ処理ユーティリティ（`src/audio/common.rs`）

2. **字幕サポート**
   - ✅ 内部表現のための字幕モデル（`src/subtitle/model.rs`）
   - ✅ 一般的な字幕フォーマットの処理（`src/subtitle/format.rs`）
   - ✅ タイミングとテキスト調整を備えた字幕エディタ（`src/subtitle/editor.rs`）
   - ✅ 視覚表現のためのスタイル管理（`src/subtitle/style.rs`）
   - ✅ 様々なフォーマットの字幕パーサー（`src/subtitle/parser.rs`）
   - ✅ 包括的なエラー処理（`src/subtitle/error.rs`）

3. **タイムライン編集機能**
   - ✅ タイムラインデータモデル設計が完了
   - ✅ マルチトラック関係管理が実装済み
   - ✅ トラック関係のシリアル化とデシリアル化
   - ✅ 基本的なクリップ操作（分割、トラック間の移動）が実装済み
   - ✅ 関連トラックにわたるクリップ操作の伝播
   - ✅ 選択的シリアル化によるプロジェクト状態の永続化
   - 🔄 元に戻す/やり直し機能を備えた編集履歴システムの最終化

4. **強化されたエラー処理とロギング**
   - ✅ すべてのモジュールの構造化エラータイプ
   - ✅ コンテキスト付きの改良されたエラーメッセージ
   - ✅ エラーのカテゴリ化と処理

#### 進行中の成果物

1. **タイムライン編集機能（残り）**
   - 🔄 元に戻す/やり直しシステムの最終化
   - 🔄 マルチトラックコンポジットによるタイムラインレンダリング
   - 🔄 関係整合性チェックを含む包括的なタイムラインの検証

2. **ドキュメント**
   - 🔄 実装された機能のユーザーガイド
   - 🔄 新モジュールのAPIドキュメント
   - 🔄 マルチトラック編集を示す例示プロジェクト

#### 主な成果

- オーディオ処理の実装は様々なシナリオで堅牢であることが証明されている
- 字幕サポートは良好な互換性を持つ複数のフォーマットを処理する
- マルチトラック関係のシリアル化が堅牢なエラー処理で完了
- トラック関係の永続化が複雑なタイムライン構造の保存と読み込みをサポート
- 基本的なクリップ操作と関連トラックにわたる伝播が実装された
- 大規模プロジェクトの効率的な処理のための選択的シリアル化システム
- エラー処理がコードベース全体で大幅に改善された
- コード品質とテストが高い水準で維持されている

#### 課題と解決策

- **参照ライフタイム**: FFmpegコマンドオプションの問題が所有権モデルの改善によって対処された
- **可変借用**: 借用チェッカーの競合を避けるために字幕トラック管理がリファクタリングされた
- **フォーマット互換性**: 当初の予想を超えて字幕フォーマットの互換性を確保するために追加作業が必要だった
- **タイムラインシリアル化**: トラック関係の復元プロセスにおける複雑な可変借用の問題を解決
- **循環依存関係**: デシリアル化中に無効なトラック関係を防ぐためのセーフガードを実装

#### 次のステップ

現在の焦点は、残りのタイムライン編集機能の完成です：

1. タイムライン操作のための元に戻す/やり直しシステムを最終化する
2. マルチトラックコンポジットによるタイムラインレンダリングを強化する
3. 関係整合性チェックを含む包括的な検証を実装する
4. マルチトラック編集の例を含むドキュメントを完成させる
5. 最近追加されたすべての機能のテストカバレッジを改善する

これらのコンポーネントが完成すると、フェーズ2は完了したと見なされ、開発はフェーズ3に進みます。

## タイムライン

- **期間**: 4-6週間
- **ステータス**: 進行中

## 主要コンポーネント

### キーフレームアニメーション実装（完了）

キーフレームアニメーションシステムは、時間経過に伴うプロパティ値の動的な変更を可能にするためにこのフェーズで実装されました。このシステムにより、キーポイント間の値を補間してスムーズなトランジションやエフェクトを実現できます。

#### 実装された機能

1. **コアアニメーションデータ構造**
   - `KeyframePoint`: 関連するイージング関数を持つ、特定の時間における値を表現
   - `KeyframeTrack`: 単一のプロパティに対するキーフレームのコレクションを管理
   - `KeyframeAnimation`: 異なるプロパティの複数のトラックを調整

2. **イージング関数**
   - 一定速度の変化のための線形補間
   - 徐々に加速するためのイーズイン
   - 徐々に減速するためのイーズアウト
   - スムーズな加速と減速のためのイーズインアウト
   - 突然の変化のためのステップ関数

3. **タイムライン統合**
   - トラック構造にキーフレームサポートを追加
   - キーフレームの追加、更新、削除のためのメソッドを実装
   - 任意の時点でのプロパティ値取得のための値補間ロジックを作成

4. **履歴とUndo/Redoサポート**
   - キーフレーム操作を追跡するために履歴システムを拡張
   - すべてのキーフレームアクションのためのundo/redo機能を実装
   - 関連するキーフレーム変更をグループ化するためのトランザクションサポートを追加

#### 実装の詳細

キーフレームシステムは以下のように設計されています：
- **柔軟性**: あらゆる数値プロパティで動作
- **拡張性**: より複雑なプロパティタイプをサポートするために拡張可能
- **効率性**: 高速な検索と補間のために最適化されたデータ構造を使用
- **直感性**: アニメーション作成のためのわかりやすいAPIを提供

この実装は、多次元プロパティアニメーションや視覚的なキーフレーム編集など、将来のフェーズでのより高度なアニメーション機能の基礎を築きます。 